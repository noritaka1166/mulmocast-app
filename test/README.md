# MulmoCast App テストガイド

このディレクトリには MulmoCast Electron アプリの Playwright テストが含まれています。

## テストファイル

### 1. `automated_e2e_test.ts` 
**完全自動E2Eテスト（CI/CD対応）**

- Electronアプリを自動で起動・終了
- 新規プロジェクト作成テスト
- 全Scriptタブのクリックテスト → ここまで動作確認済み
- GitHub Actions での使用を想定

**使用方法:**
```bash
# TypeScriptファイルを直接実行
npx ts-node test/automated_e2e_test.ts

# または事前にコンパイルして実行
npx tsc test/automated_e2e_test.ts
```

**特徴:**
- ✅ 自動でElectronアプリを起動
- ✅ テスト完了後に自動でアプリを終了
- ✅ CI/CD環境での使用が可能
- ✅ プロセスグループ終了によるクリーンアップ
- ✅ TypeScriptによる型安全性
- ✅ CDP接続のポーリング機能（固定待機時間なし）

**環境変数:**
- `CDP_URL`: CDP接続URL（デフォルト: `http://localhost:9222/`）
- `APP_URL`: アプリケーションURL（デフォルト: `localhost:5173`）

### 2. `manual_electron_test.ts`
**手動起動済みアプリへの接続テスト**

- 既に起動中のElectronアプリに接続
- CDP (Chrome DevTools Protocol) 経由でアクセス
- 開発時の手軽なテストに適している

**使用方法:**
```bash
# 1. まずElectronアプリを起動
yarn start

# 2. 別のターミナルでテストを実行（TypeScript）
npx ts-node test/manual_electron_test.ts

# または事前にコンパイルして実行
npx tsc test/manual_electron_test.ts
```

**特徴:**
- ✅ 既に起動中のアプリに接続
- ✅ アプリの起動・終了は手動
- ✅ 開発時の反復テストに便利
- ✅ CDP接続（ポート9222）
- ✅ TypeScriptによる型安全性
- ✅ CDP接続のポーリング機能（最大30回リトライ）

**環境変数:**
- `CDP_URL`: CDP接続URL（デフォルト: `http://localhost:9222/`）
- `APP_URL`: アプリケーションURL（デフォルト: `localhost:5173`）

### 3. `manual_run_switch_language.ts`
**言語切り替え機能テスト**

- アプリケーションの表示言語を切り替えるテスト
- 設定画面へのナビゲーションと言語変更を自動化
- 元のページへの自動復帰機能付き

**使用方法:**
```bash
# 1. まずElectronアプリを起動
yarn start

# 2. 別のターミナルで言語を指定してテスト実行
# 日本語に変更
npx tsx test/manual_run_switch_language.ts ja

# 英語に変更
npx tsx test/manual_run_switch_language.ts en
```

**テストフロー:**
1. 現在のページURLを記憶
2. ハンバーガーメニューを開く
3. 設定画面へ移動
4. 言語ドロップダウンから指定言語を選択
5. 言語変更を確認
6. 元のページへ自動で戻る

**特徴:**
- ✅ data-testidベースの安定したセレクタ
- ✅ 言語変更の自動確認
- ✅ 元ページへの自動復帰
- ✅ コマンドライン引数で言語指定

## 前提条件

### 1. 依存関係のインストール
```bash
yarn install
```

### 2. Playwright の設定
- `playwright` パッケージがインストール済み
- `src/main/main.ts` で開発環境でのCDP有効化済み

### 3. 環境設定
開発環境でのみCDPポートが有効化されるよう設定済み:
```typescript
// src/main/main.ts
if (isDev) {
  app.commandLine.appendSwitch("remote-debugging-port", "9222");
}
```

## テスト内容

両方のテストで以下の操作を実行:

1. **新規プロジェクト作成**
   - 「新規作成」ボタンをクリック
   - 日付+時刻のタイトルを入力（例: `20250127_123456`）
   - 「Create」ボタンをクリック

2. **Scriptタブテスト**
   - 全6つのタブをクリック: `Text`, `YAML`, `JSON`, `Media`, `Style`, `Ref`
   - 各タブのアクティブ状態を確認

## GitHub Actions での使用 → 未確認

`.github/workflows/playwright_test.yml` で `automated_e2e_test.ts` が使用されます:

```yaml
- name: Run Playwright tests (with xvfb)
  run: |
    xvfb-run -a npx ts-node test/automated_e2e_test.ts
  env:
    CI: true
    NODE_ENV: test
```

## トラブルシューティング → Generated by Claude Code 

### よくある問題

1. **「No browser contexts found」エラー**
   - Electronアプリが完全に起動していない
   - 15秒程度待ってから再試行

2. **「Network service crashed」メッセージ**
   - 正常な終了プロセスの一部
   - エラーではありません

3. **プロセスが残り続ける**
   - `automated_e2e_test.js` では解決済み
   - プロセスグループ終了を使用

4. **CDP接続エラー**
   - ポート9222が使用中の可能性
   - 他のElectronプロセスを終了してから再試行

## data-testid 命名規則

E2Eテストの安定性を確保するため、以下の命名規則に従って`data-testid`属性を設定してください。

### 基本的な命名パターン

1. **ボタン**: `{action}-button`
   - 例: `data-testid="menu-button"`
   - 例: `data-testid="submit-button"`
   - 例: `data-testid="cancel-button"`

2. **メニューアイテム**: `menu-item-{name}`
   - 例: `data-testid="menu-item-settings"`
   - 例: `data-testid="menu-item-dashboard"`

3. **セレクト/ドロップダウン**: `{name}-select`
   - 例: `data-testid="language-select"`
   - 例: `data-testid="provider-select"`

4. **セレクトオプション**: `{name}-option-{value}`
   - 例: `data-testid="language-option-ja"`
   - 例: `data-testid="language-option-en"`

5. **入力フィールド**: `{name}-input`
   - 例: `data-testid="title-input"`
   - 例: `data-testid="api-key-input"`

6. **タブ**: `tab-{name}`
   - 例: `data-testid="tab-text"`
   - 例: `data-testid="tab-media"`

### 命名のベストプラクティス

- **小文字とハイフン**: kebab-caseで統一
- **具体的で説明的**: 機能や目的が明確にわかる名前
- **動的な値**: テンプレートリテラルを使用
  ```vue
  :data-testid="`option-${option.id}`"
  ```

### Vueコンポーネントでの実装例

```vue
<!-- 静的なdata-testid -->
<Button data-testid="submit-button" @click="submit">
  Submit
</Button>

<!-- 動的なdata-testid -->
<SelectItem 
  v-for="option in options" 
  :key="option.id"
  :value="option.id"
  :data-testid="`option-${option.id}`"
>
  {{ option.label }}
</SelectItem>
```

## 開発者向けメモ → Generated by Claude Code プレフィックス、テスト内容は要検討。まずは、Playwright x Electron の確認は完了です。

- 新しいテストを追加する場合は適切なファイル名を使用
- CI/CD用テストは `automated_` プレフィックス
- 手動テスト用は `manual_` プレフィックス
- 全てのテストでプロジェクトタイトルにタイムスタンプを使用